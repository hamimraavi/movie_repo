#!/bin/bash

# $1 - destination directory containing movies



function preprocess_temps(){
  #TODO(hamim): Remove local temp files

  #mkdir tmp1
  touch /tmp/movielist.txt
  touch /tmp/output.txt
  ls $1 > /tmp/movielist.txt
}

function print_results(){
  echo "Ratings                      Movie"
  echo "========================================================"
  sort -k 1 -r /tmp/output.txt
}

main(){

  preprocess_temps $1

  for ((i=1;; i++)); do
	
  read name || break;
  
  original_name=$name

  name=${name// /.} 				 # Replace all spaces with dot
  name=${name//_/.} 				 # Replace all underscores with dot
  name=${name//-/.} 				 # Replace all hyphens with dot
  name=${name//:/.} 				 # Replace all colons with dot
	
  url="http://www.omdbapi.com/?t=$name&y=&plot=short&r=xml"

  curl_result=$(curl -s $url)
  
  #rat1=grep -o 'imdbRating.*' | cut -f2- -d':' 

  #echo $rat1

  rating="${curl_result#*imdbRating}"
  rating="${rating%%%%}"
  res=${rating:2:3}

  #TODO(hamim): Use an alternate approach for field extraction

  regex='[0-9]\.[0-9]'

  if ! [[ $res =~ $regex ]]; then
    res=N/A
  fi	
	
  echo "  ${res}   ${original_name}" >> /tmp/output.txt	 
		
  done < /tmp/movielist.txt

  print_results

  #rm -r tmp1 
}

main "$@"

